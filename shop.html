<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Bodhi Swan Ceramics</title>
    
    <!-- Add Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Previous head content remains the same -->
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="shortcut icon" href="assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Bodhi Swan" />
    <link rel="manifest" href="assets/site.webmanifest" />
    
    <style>
        /* Previous styles remain the same */
        /* Add new styles for out of stock */
        .out-of-stock-label {
            background-color: #dc3545;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .product-card.out-of-stock {
            opacity: 0.7;
        }

        .product-card.out-of-stock img {
            filter: grayscale(1);
        }

        .stock-label {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .in-stock {
            background-color: #28a745;
            color: white;
        }

        .low-stock {
            background-color: #ffc107;
            color: #333;
        }

        .out-of-stock {
            background-color: #dc3545;
            color: white;
        }

        /* Previous styles remain the same */
    </style>
</head>
<body>
    <div class="container">
        <!-- Previous navigation and header remain the same -->
        <div class="shop-grid" id="productGrid">
            <!-- Products will be loaded dynamically -->
            <div class="loading">Checking inventory...</div>
        </div>
    </div>

    <template id="product-template">
        <div class="product-card">
            <img src="bodhiswan_348455879_578736824387942_7902606742957668195_n.jpg" 
                 alt="Hand-thrown espresso cup with smooth glaze finish" 
                 class="product-image" 
                 loading="lazy">
            <div class="product-info">
                <h2 class="product-title">Handcrafted Espresso Cup</h2>
                <p class="product-description">A meticulously wheel-thrown espresso cup, perfect for your morning ritual. Features a smooth interior glaze and natural exterior finish.</p>
                <div class="product-metadata">
                    <p>Dimensions: 6cm x 6cm x 7cm</p>
                    <p>Materials: Stoneware clay, Clear glaze interior</p>
                    <p>Care: Dishwasher and microwave safe</p>
                </div>
                <div class="stock-status"></div>
                <div class="product-price">$100.00</div>
                <button class="buy-button">Purchase</button>
                <div class="error-message"></div>
            </div>
        </div>
    </template>

    <script>
        // Initialize Stripe
        const stripe = Stripe('pk_test_51QXtAPAw2iyVnuCTMK1jALjOxfkmxfmG3poiqB3R61Q49Okacmeaiof8yIyHQ6yEXpRVMCAfezjmQrEL7LoM339C00WqaGmwJM');

        async function checkInventory(priceId) {
            try {
                const response = await fetch(`https://api.stripe.com/v1/products/prod_RQnDem9qTVNwXW`, {
                    headers: {
                        'Authorization': `Bearer ${stripe._apiKey}`
                    }
                });
                const product = await response.json();
                
                // Get inventory from metadata
                const inventory = parseInt(product.metadata.inventory || '0');
                return inventory;
            } catch (error) {
                console.error('Error checking inventory:', error);
                return 0;
            }
        }

        async function initializeProduct() {
            const productGrid = document.getElementById('productGrid');
            const template = document.getElementById('product-template');
            
            // Clear loading message
            productGrid.innerHTML = '';
            
            // Clone template
            const productCard = template.content.cloneNode(true);
            const inventory = await checkInventory();
            
            // Update stock status
            const stockStatus = productCard.querySelector('.stock-status');
            const buyButton = productCard.querySelector('.buy-button');
            
            if (inventory > 5) {
                stockStatus.innerHTML = `<span class="stock-label in-stock">In Stock</span>`;
            } else if (inventory > 0) {
                stockStatus.innerHTML = `<span class="stock-label low-stock">Only ${inventory} left</span>`;
            } else {
                stockStatus.innerHTML = `<span class="stock-label out-of-stock">Out of Stock</span>`;
                productCard.querySelector('.product-card').classList.add('out-of-stock');
                buyButton.disabled = true;
                buyButton.textContent = 'Out of Stock';
            }

            // Add click handler if in stock
            if (inventory > 0) {
                buyButton.addEventListener('click', handlePurchase);
            }
            
            productGrid.appendChild(productCard);
        }

        async function handlePurchase() {
            const buyButton = this;
            const errorMessage = buyButton.parentElement.querySelector('.error-message');
            
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            
            buyButton.disabled = true;
            buyButton.textContent = 'Processing...';

            try {
                const result = await stripe.redirectToCheckout({
                    lineItems: [{
                        price: 'price_1QXvdTAw2iyVnuCTJFYeuJwM',
                        quantity: 1
                    }],
                    mode: 'payment',
                    successUrl: `${window.location.origin}/success.html`,
                    cancelUrl: `${window.location.origin}/shop.html`,
                    shippingAddressCollection: {
                        allowedCountries: ['AU'],
                    }
                });

                if (result.error) {
                    throw new Error(result.error.message);
                }
            } catch (error) {
                console.error('Detailed error:', error);
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
                buyButton.disabled = false;
                buyButton.textContent = 'Purchase';
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', initializeProduct);
    </script>
</body>
</html>
