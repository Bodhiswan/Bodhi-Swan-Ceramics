<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup - Auto Add Classes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .config-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
        .log {
            background: #f1f3f4;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>üî• Firebase Auto Setup Tool</h1>
    <p>This tool will automatically add your pottery class availability to Firebase.</p>

    <div class="container">
        <h2>Step 1: Configure Firebase</h2>
        <div class="config-section">
            <label for="firebaseConfig">Paste Your Firebase Config:</label>
            <textarea id="firebaseConfig" rows="8" placeholder='Paste your Firebase config here, like:
{
  "apiKey": "AIzaSyC...",
  "authDomain": "your-project.firebaseapp.com",
  "projectId": "your-project-id",
  "storageBucket": "your-project.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "1:123456789:web:abc123"
}'></textarea>
            <button class="btn" onclick="initializeFirebase()">Connect to Firebase</button>
        </div>
    </div>

    <div class="container">
        <h2>Step 2: Configure Your Schedule</h2>
        <div class="config-section">
            <h3>Regular Weekly Classes</h3>
            <label>
                <input type="checkbox" id="mondayClasses" checked> Monday Evening Classes (6:00 PM)
            </label>
            <label>
                <input type="checkbox" id="wednesdayClasses"> Wednesday Evening Classes (7:00 PM)
            </label>
            <label>
                <input type="checkbox" id="saturdayWorkshops"> Saturday Workshops (10:00 AM, 2:00 PM)
            </label>
            
            <h3>Class Settings</h3>
            <label for="classCapacity">Class Capacity:</label>
            <input type="number" id="classCapacity" value="6" min="1" max="20">
            
            <label for="workshopCapacity">Workshop Capacity:</label>
            <input type="number" id="workshopCapacity" value="8" min="1" max="20">
            
            <label for="monthsAhead">Generate classes for how many months ahead:</label>
            <input type="number" id="monthsAhead" value="3" min="1" max="12">
        </div>
    </div>

    <div class="container">
        <h2>Step 3: Generate Classes</h2>
        <button class="btn" onclick="generateClasses()" id="generateBtn" disabled>Generate All Classes</button>
        <button class="btn" onclick="addAdminUser()">Add Admin User</button>
        <button class="btn" onclick="clearAllData()" style="background: #dc3545;">Clear All Data</button>
    </div>

    <div class="container">
        <h2>Progress Log</h2>
        <div id="log" class="log">Ready to start...\n</div>
    </div>

    <script>
        let db = null;
        let auth = null;

        function log(message) {
            const logEl = document.getElementById('log');
            logEl.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function showSuccess(message) {
            const container = document.querySelector('.container:last-of-type');
            const successEl = document.createElement('div');
            successEl.className = 'success';
            successEl.textContent = message;
            container.insertBefore(successEl, container.lastElementChild);
        }

        function showError(message) {
            const container = document.querySelector('.container:last-of-type');
            const errorEl = document.createElement('div');
            errorEl.className = 'error';
            errorEl.textContent = message;
            container.insertBefore(errorEl, container.lastElementChild);
        }

        function initializeFirebase() {
            try {
                const configText = document.getElementById('firebaseConfig').value.trim();
                let config;
                
                log('üîç Parsing config...');
                
                // Handle different config formats
                if (configText.includes('const firebaseConfig')) {
                    // Extract from JavaScript code with const declaration
                    const match = configText.match(/const firebaseConfig\s*=\s*\{([\s\S]*?)\};/);
                    if (match) {
                        // Reconstruct the object
                        const objectContent = match[1];
                        const configString = '{' + objectContent + '}';
                        
                        // Clean up the JavaScript object to make it valid JSON
                        let cleanConfig = configString
                            .replace(/(\w+):/g, '"$1":')  // Add quotes around keys
                            .replace(/'/g, '"')           // Replace single quotes with double quotes
                            .replace(/,\s*}/g, '}')       // Remove trailing commas
                            .replace(/,\s*\n\s*}/g, '}'); // Remove trailing commas with newlines
                        
                        config = JSON.parse(cleanConfig);
                        log('‚úÖ Parsed JavaScript config format');
                    } else {
                        throw new Error('Could not extract config from JavaScript');
                    }
                } else if (configText.startsWith('{')) {
                    // Direct JSON object
                    config = JSON.parse(configText);
                    log('‚úÖ Parsed JSON config format');
                } else {
                    // Try to extract just the object part
                    const match = configText.match(/\{[\s\S]*\}/);
                    if (match) {
                        let cleanConfig = match[0]
                            .replace(/(\w+):/g, '"$1":')
                            .replace(/'/g, '"')
                            .replace(/,\s*}/g, '}');
                        config = JSON.parse(cleanConfig);
                        log('‚úÖ Parsed extracted object format');
                    } else {
                        throw new Error('Invalid config format. Please paste the entire firebaseConfig object.');
                    }
                }

                // Validate required fields
                const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                for (const field of requiredFields) {
                    if (!config[field]) {
                        throw new Error(`Missing required field: ${field}`);
                    }
                }

                log('‚úÖ Config validation passed');
                log('üöÄ Initializing Firebase...');

                // Initialize Firebase
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(config);
                } else {
                    // Reinitialize if needed
                    firebase.app().delete().then(() => {
                        firebase.initializeApp(config);
                    });
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                
                log('‚úÖ Firebase connected successfully!');
                log('üìä Project: ' + config.projectId);
                showSuccess('Firebase connected! You can now generate classes.');
                document.getElementById('generateBtn').disabled = false;
                
            } catch (error) {
                log('‚ùå Firebase connection failed: ' + error.message);
                log('üìù Config received: ' + document.getElementById('firebaseConfig').value.substring(0, 100) + '...');
                showError('Failed to connect to Firebase: ' + error.message);
            }
        }

        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getDayName(dayNum) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[dayNum];
        }

        async function generateClasses() {
            if (!db) {
                showError('Please connect to Firebase first!');
                return;
            }

            try {
                log('üöÄ Starting class generation...');
                
                const mondayClasses = document.getElementById('mondayClasses').checked;
                const wednesdayClasses = document.getElementById('wednesdayClasses').checked;
                const saturdayWorkshops = document.getElementById('saturdayWorkshops').checked;
                const classCapacity = parseInt(document.getElementById('classCapacity').value);
                const workshopCapacity = parseInt(document.getElementById('workshopCapacity').value);
                const monthsAhead = parseInt(document.getElementById('monthsAhead').value);

                const today = new Date();
                const endDate = new Date(today.getFullYear(), today.getMonth() + monthsAhead, today.getDate());
                
                let classCount = 0;
                const batch = db.batch();

                for (let date = new Date(today); date <= endDate; date.setDate(date.getDate() + 1)) {
                    const dayOfWeek = date.getDay();
                    const dateKey = formatDateKey(date);
                    const dayName = getDayName(dayOfWeek);
                    
                    let classData = null;

                    // Monday evening classes
                    if (dayOfWeek === 1 && mondayClasses) {
                        classData = {
                            dateKey: dateKey,
                            date: new Date(date),
                            dayOfWeek: dayName,
                            times: ['6:00 PM'],
                            maxCapacity: classCapacity,
                            currentBookings: 0,
                            classType: 'regular'
                        };
                    }
                    
                    // Wednesday evening classes
                    if (dayOfWeek === 3 && wednesdayClasses) {
                        classData = {
                            dateKey: dateKey,
                            date: new Date(date),
                            dayOfWeek: dayName,
                            times: ['7:00 PM'],
                            maxCapacity: classCapacity,
                            currentBookings: 0,
                            classType: 'regular'
                        };
                    }
                    
                    // Saturday workshops
                    if (dayOfWeek === 6 && saturdayWorkshops) {
                        classData = {
                            dateKey: dateKey,
                            date: new Date(date),
                            dayOfWeek: dayName,
                            times: ['10:00 AM', '2:00 PM'],
                            maxCapacity: workshopCapacity,
                            currentBookings: 0,
                            classType: 'workshop'
                        };
                    }

                    if (classData) {
                        const docRef = db.collection('availability').doc();
                        batch.set(docRef, classData);
                        classCount++;
                        
                        if (classCount % 10 === 0) {
                            log(`üìÖ Generated ${classCount} classes...`);
                        }
                    }
                }

                // Commit all classes at once
                await batch.commit();
                
                log(`‚úÖ Successfully generated ${classCount} classes!`);
                showSuccess(`Generated ${classCount} classes successfully! Your booking system is ready.`);
                
            } catch (error) {
                log('‚ùå Error generating classes: ' + error.message);
                showError('Failed to generate classes: ' + error.message);
            }
        }

        async function addAdminUser() {
            if (!db) {
                showError('Please connect to Firebase first!');
                return;
            }

            try {
                log('üë§ Adding admin user...');
                
                await db.collection('admin').doc('admin-user-1').set({
                    email: 'swan1995@gmail.com',
                    role: 'admin',
                    createdAt: new Date()
                });
                
                log('‚úÖ Admin user added successfully!');
                showSuccess('Admin user created! You now have admin access to the booking system.');
                
            } catch (error) {
                log('‚ùå Error adding admin user: ' + error.message);
                showError('Failed to add admin user: ' + error.message);
            }
        }

        async function clearAllData() {
            if (!db) {
                showError('Please connect to Firebase first!');
                return;
            }

            if (!confirm('Are you sure you want to delete ALL availability data? This cannot be undone!')) {
                return;
            }

            try {
                log('üóëÔ∏è Clearing all availability data...');
                
                const snapshot = await db.collection('availability').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                log(`‚úÖ Deleted ${snapshot.docs.length} availability records`);
                showSuccess('All availability data cleared!');
                
            } catch (error) {
                log('‚ùå Error clearing data: ' + error.message);
                showError('Failed to clear data: ' + error.message);
            }
        }
    </script>
</body>
</html>